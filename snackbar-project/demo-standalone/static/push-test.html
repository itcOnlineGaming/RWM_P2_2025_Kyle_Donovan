<!DOCTYPE html>
<html>
<head>
  <title>Push Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
      background: #7a5de6;
      color: white;
      border: none;
      border-radius: 6px;
    }
    button:hover {
      background: #6a4dd6;
    }
    .status {
      padding: 15px;
      margin: 20px 0;
      background: #f0f0f0;
      border-radius: 6px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Push Notification Test</h1>
  
  <div id="status" class="status">Checking...</div>
  
  <button onclick="requestPermission()">1. Request Permission</button>
  <button onclick="subscribeToPush()">2. Subscribe to Push</button>
  <button onclick="testPush()">3. Test Push from Server</button>
  
  <h2>Instructions:</h2>
  <ol>
    <li>Click "Request Permission" and allow notifications</li>
    <li>Click "Subscribe to Push" to register with server</li>
    <li>Click "Test Push from Server" to receive a notification</li>
    <li>You can close this tab and the notification should still arrive!</li>
  </ol>
  
  <script>
    const VAPID_PUBLIC_KEY = 'BB0mh7LqN9ykwQ6JehCD58ogN9Lphh3LVJ7QaFm6iUZJh5Hr_FfXt9ey4OOyU-BuJblIu2v2ycVShK7WSoy46vE';
    
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    
    async function requestPermission() {
      const permission = await Notification.requestPermission();
      updateStatus(`Permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
      
      if (permission === 'granted') {
        // Register service worker from the correct path
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/Team_4/sw.js', { scope: '/Team_4/' })
            .then(reg => {
              console.log('✅ Service worker registered');
              updateStatus('✅ Service worker registered and permission granted!', 'success');
            })
            .catch(err => {
              console.error('Service worker registration failed:', err);
              updateStatus(`❌ Service worker error: ${err.message}`, 'error');
            });
        }
      }
    }
    
    async function subscribeToPush() {
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        
        const response = await fetch('http://localhost:3000/subscribe', {
          method: 'POST',
          body: JSON.stringify(subscription),
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          updateStatus('✅ Subscribed to push notifications!', 'success');
        } else {
          updateStatus('❌ Failed to subscribe', 'error');
        }
      } catch (error) {
        updateStatus(`❌ Error: ${error.message}`, 'error');
      }
    }
    
    async function testPush() {
      try {
        const response = await fetch('http://localhost:3000/trigger');
        const text = await response.text();
        updateStatus(`✅ ${text}`, 'success');
      } catch (error) {
        updateStatus(`❌ Server error: ${error.message}`, 'error');
      }
    }
    
    function updateStatus(message, type = '') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
    
    // Check initial status
    if ('Notification' in window) {
      updateStatus(`Notifications supported. Permission: ${Notification.permission}`);
    } else {
      updateStatus('❌ Notifications not supported in this browser', 'error');
    }
  </script>
</body>
</html>
